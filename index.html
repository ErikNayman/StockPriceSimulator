<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCF + XIRR Simulator (Growth / Value)</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <style>
    :root{--bg:#f4f6f9;--card:#fff;--pri:#2b7cff;--b:#ddd;--mut:#555}
    *{box-sizing:border-box}
    body{margin:0;padding:2rem;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#222}
    .container{max-width:1100px;margin:auto;background:var(--card);padding:2rem 2.4rem;border-radius:12px;box-shadow:0 3px 14px rgba(0,0,0,.08)}
    h1{font-size:1.5rem;margin-bottom:1rem}
    .grid{display:grid;grid-template-columns:250px 1fr 90px;gap:.85rem;margin-bottom:.8rem}
    label{font-weight:600;margin-top:.32rem}
    input{width:100%;padding:6px 8px;border:1px solid var(--b);border-radius:4px}
    small{grid-column:2/4;color:var(--mut);font-size:.78rem;margin:-.3rem 0 .35rem}
    button{padding:10px 22px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-weight:700;font-size:1rem;cursor:pointer;margin-top:.6rem}
    button:hover{opacity:.93}
    table{margin-top:1.1rem;border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--b);padding:6px;text-align:center;font-size:.85rem}
    .plot{height:420px;width:100%;margin-top:1.25rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>DCF & XIRR Calculator (P/B/O scenarios + horizon sensitivity)</h1>

    <div class="grid">
      <label>Current share price ($)</label><input id="priceNow" type="number" value="100" step="0.1"><small>Market price today</small>
      <label>Current revenue (B$)</label><input id="rev" type="number" value="50" step="1"><small>Last FY total revenue</small>
      <label>YoY revenue growth % (last)</label><input id="g0" type="number" value="20" step="0.1"><small>Trailing growth</small>
      <label>TAM ceiling (B$)</label><input id="tam" type="number" value="300" step="10"><small>Total addressable market</small>
      <label>Current net margin %</label><input id="m0" type="number" value="-5" step="0.1"><small>Net income ÷ revenue</small>
      <label>Peak net margin %</label><input id="mPeak" type="number" value="20" step="0.5"><small>Sustainable peak</small>
      <label>Dividend payout %</label><input id="payout" type="number" value="40" step="1"><small>% of NI paid as dividend</small>
      <label>Shares outstanding (B)</label><input id="shares" type="number" value="1" step="0.01"><small>Diluted shares</small>
      <label>Discount rate (WACC %)</label><input id="wacc" type="number" value="9" step="0.1"><small>Required return</small>
      <label>Terminal P/E (value phase)</label><input id="peTerm" type="number" value="12" step="1"><small>Applied at horizon</small>
    </div>
    <button id="run">Run simulation</button>

    <table id="tblScen" style="display:none"><thead><tr><th>Scenario</th><th>EPS<sub>n</sub></th><th>Price<sub>future</sub></th><th>XIRR (7y)</th><th>XIRR (10y)</th><th>XIRR (15y)</th></tr></thead><tbody></tbody></table>
    <div id="chartScenario" class="plot"></div>
    <div id="chartPE" class="plot"></div>
    <small>Bottom chart — IRR vs Terminal P/E for Base scenario, 10‑year horizon.</small>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = id => document.getElementById(id);
    const qs = sel => document.querySelector(sel);
    const logistic = (t,t0,k)=>1/(1+Math.exp(-k*(t-t0)));

    function buildEPS(sc,h){
      const R0=+$('#rev').value,g0=+$('#g0').value/100,TAM=+$('#tam').value,
            m0=+$('#m0').value/100,mPk=+$('#mPeak').value/100,sh=+$('#shares').value;
      const adj={P:0.6,B:1,O:1.3}[sc];
      const gPk=g0*adj,tPk=5*adj,k=0.4/adj,mShift=(mPk-m0)*adj;
      let R=R0,eps=[];
      for(let t=1;t<=h;t++){
        const g=gPk*(1-logistic(t,tPk,k));
        R=Math.min(R*(1+g),TAM);
        const m=m0+mShift*logistic(t,tPk,k);
        eps.push((R*m)/sh);
      }
      return eps;
    }

    const cashFlow=(price0,epsArr,payout,pe)=>{
      const cf=[-price0];
      epsArr.forEach(e=>cf.push(e*payout));
      cf[cf.length-1]+=epsArr.at(-1)*pe;
      return cf;
    };

    function IRR(cf,guess=0.1){
      let r=guess;
      for(let i=0;i<100;i++){
        let f=0,df=0;
        cf.forEach((c,t)=>{ const pv=Math.pow(1+r,t); f+=c/pv; if(t>0) df+=-t*c/Math.pow(1+r,t+1);});
        const rNew=r-f/df;
        if(Math.abs(rNew-r)<1e-6) return rNew;
        r=rNew;
      }
      return NaN;
    }

    document.addEventListener('DOMContentLoaded',()=>{
      const runBtn=$('#run');
      if(!runBtn) return; // safety guard
      runBtn.addEventListener('click',()=>{
        const priceNow=+$('#priceNow').value,payout=+$('#payout').value/100,peT=+$('#peTerm').value;
        const scenarios=['P','B','O'], horizons=[7,10,15];

        const tbody=qs('#tblScen tbody'); if(tbody) tbody.innerHTML='';
        const irrBar=[];

        scenarios.forEach(sc=>{
          const eps10=buildEPS(sc,10);
          const epsMap={7:eps10.slice(0,7),10:eps10,15:[...eps10,...buildEPS(sc,5)]};
          const irr={};
          horizons.forEach(h=>irr[h]=IRR(cashFlow(priceNow,epsMap[h],payout,peT))*100);
          const priceF=eps10.at(-1)*peT;
          if(tbody) tbody.insertAdjacentHTML('beforeend',`<tr><td>${sc}</td><td>${eps10.at(-1).toFixed(2)}</td><td>${priceF.toFixed(2)}</td><td>${irr[7].toFixed(2)}%</td><td>${irr[10].toFixed(2)}%</td><td>${irr[15].toFixed(2)}%</td></tr>`);
          irrBar.push(irr[10]);
        });
        const tbl=$('#tblScen'); if(tbl) tbl.style.display='table';

        Plotly.newPlot('chartScenario',[{x:scenarios,y:irrBar,type:'bar',marker:{color:['#ff6961','#f0ad4e','#5cb85c']}}],{title:'IRR (10‑year horizon)',yaxis:{title:'IRR %'},margin:{t:40}});

        const peRange=Array.from({length:13},(_,i)=>8+i);
        const irrPE=peRange.map(pe=>IRR(cashFlow(priceNow,buildEPS('B',10),payout,pe))*100);
        Plotly.newPlot('chartPE',[{x:peRange,y:irrPE,type:'scatter',mode:'lines+markers'}],{title:'IRR vs Terminal P/E (Base, 10y)',xaxis:{title:'Terminal P/E'},yaxis:{title:'IRR %'},margin:{t:40}});
      });
    });
  </script>
</body>
</html>
