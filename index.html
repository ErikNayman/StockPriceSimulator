<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCF + XIRR Simulator (P/B/O)</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <style>
    :root{--bg:#f4f6f9;--card:#fff;--pri:#2b7cff;--b:#ddd;--mut:#555}
    *{box-sizing:border-box}
    body{margin:0;padding:2rem;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#222}
    .wrap{max-width:1100px;margin:auto;background:var(--card);padding:2rem 2.4rem;border-radius:12px;box-shadow:0 3px 14px rgba(0,0,0,.08)}
    h1{font-size:1.5rem;margin-bottom:1rem}
    .grid{display:grid;grid-template-columns:240px 1fr 90px;gap:.9rem;margin-bottom:1rem}
    label{font-weight:600;margin-top:.32rem}
    input{width:100%;padding:6px;border:1px solid var(--b);border-radius:4px}
    small{grid-column:2/4;color:var(--mut);font-size:.78rem;margin:-.3rem 0 .35rem}
    button{padding:10px 22px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-weight:700;font-size:1rem;cursor:pointer;margin-top:.6rem}
    button:hover{opacity:.93}
    table{margin-top:1rem;border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--b);padding:6px;text-align:center;font-size:.85rem}
    .plot{height:420px;width:100%;margin-top:1.3rem}
  </style>
</head>
<body>
<div class="wrap">
  <h1>DCF & XIRR — 3 Scenarios + PE Sensitivity</h1>
  <div class="grid">
    <label>Share price, $</label><input id="pNow" type="number" value="100" step="0.1"><small>Market close today</small>
    <label>Revenue, B$</label><input id="rev" type="number" value="50" step="1">
    <label>YoY growth %</label><input id="g0" type="number" value="20" step="0.1">
    <label>TAM, B$</label><input id="tam" type="number" value="300" step="10">
    <label>Net margin %</label><input id="m0" type="number" value="-5" step="0.1">
    <label>Peak margin %</label><input id="mPk" type="number" value="20" step="0.5">
    <label>Payout %</label><input id="pay" type="number" value="40" step="1"><small>Dividends / NI</small>
    <label>Shares, B</label><input id="sh" type="number" value="1" step="0.01">
    <label>Terminal P/E</label><input id="peT" type="number" value="12" step="1">
  </div>
  <button id="run">Run simulation</button>

  <table id="tbl" style="display:none"><thead><tr><th>Scenario</th><th>EPS<sub>n</sub></th><th>Future Price</th><th>XIRR 7y</th><th>XIRR 10y</th><th>XIRR 15y</th></tr></thead><tbody></tbody></table>
  <div id="bar" class="plot"></div>
  <div id="line" class="plot"></div>
</div>

<script>
const $ = id=>document.getElementById(id);
const get = id=>+($(id)?.value||0);
const logistic=(t,t0,k)=>1/(1+Math.exp(-k*(t-t0)));
function epsPath(s,yrs){
  const R0=get('rev'), g0=get('g0')/100, TAM=get('tam'), m0=get('m0')/100, mPk=get('mPk')/100, sh=get('sh');
  const adj={P:0.6,B:1,O:1.3}[s];
  const gPk=g0*adj, tPk=5*adj, k=0.4/adj, mShift=(mPk-m0)*adj;
  let R=R0, arr=[];
  for(let t=1;t<=yrs;t++){
    const g=gPk*(1-logistic(t,tPk,k));
    R=Math.min(R*(1+g),TAM);
    const margin=m0+mShift*logistic(t,tPk,k);
    arr.push((R*margin)/sh);
  }
  return arr;
}
const cashFlows=(P,eps,pay,pe)=>{
  const cf=[-P]; eps.forEach(e=>cf.push(e*pay)); cf[cf.length-1]+=eps.at(-1)*pe; return cf;
};
function IRR(cf){let r=0.1;for(let i=0;i<100;i++){let f=0,df=0;cf.forEach((c,t)=>{const d=Math.pow(1+r,t);f+=c/d;if(t>0)df+=-t*c/Math.pow(1+r,t+1);});if(Math.abs(df)<1e-9)return null;const rN=r-f/df;if(!isFinite(rN))return null;if(Math.abs(rN-r)<1e-6)return rN;r=rN;}return null;}
function simulate(){
  const price=get('pNow'), pay=get('pay')/100, peT=get('peT');
  const scenarios=['P','B','O'], yrs=[7,10,15];
  const tbody=$('#tbl tbody'); tbody.innerHTML='';
  const barData=[];
  scenarios.forEach(s=>{
    const eps10=epsPath(s,10);
    const map={7:eps10.slice(0,7),10:eps10,15:[...eps10,...epsPath(s,5)]};
    const irrVals={}; yrs.forEach(y=>{const v=IRR(cashFlows(price,map[y],pay,peT)); irrVals[y]=v? v*100 : 0; });
    const fut=eps10.at(-1)*peT;
    tbody.insertAdjacentHTML('beforeend',`<tr><td>${s}</td><td>${eps10.at(-1).toFixed(2)}</td><td>${fut.toFixed(2)}</td><td>${irrVals[7].toFixed(2)}%</td><td>${irrVals[10].toFixed(2)}%</td><td>${irrVals[15].toFixed(2)}%</td></tr>`);
    barData.push(irrVals[10]);
  });
  $('#tbl').style.display='table';
  Plotly.newPlot('bar',[{x:scenarios,y:barData,type:'bar'}]);
  const peList=Array.from({length:13},(_,i)=>8+i);
  const irrPE=peList.map(pe=>{const v=IRR(cashFlows(price,epsPath('B',10),pay,pe)); return v? v*100 : 0; });
  Plotly.newPlot('line',[{x:peList,y:irrPE,type:'scatter',mode:'lines+markers'}]);
}
window.onload=()=>{$('#run').onclick=simulate;};
</script>
</body>
</html>
