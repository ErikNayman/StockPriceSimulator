<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCF + XIRR Simulator</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js" defer></script>
  <style>
    :root{--bg:#f4f6f9;--card:#fff;--pri:#2b7cff;--b:#ddd;--mut:#555}
    *{box-sizing:border-box}body{margin:0;padding:2rem;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#222}
    .wrap{max-width:1100px;margin:auto;background:var(--card);padding:2rem;border-radius:12px;box-shadow:0 3px 14px rgba(0,0,0,.08)}
    h1{font-size:1.5rem;margin-bottom:1rem}
    .grid{display:grid;grid-template-columns:240px 1fr 90px;gap:.9rem;margin-bottom:1rem}
    label{font-weight:600;margin-top:.3rem}
    input{width:100%;padding:6px;border:1px solid var(--b);border-radius:4px}
    small{grid-column:2/4;color:var(--mut);font-size:.78rem;margin:-.28rem 0 .32rem}
    button{padding:10px 22px;background:var(--pri);color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer;margin-top:.6rem}
    button:hover{opacity:.93}
    table{margin-top:1rem;border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--b);padding:6px;text-align:center;font-size:.85rem}
    .plot{height:420px;width:100%;margin-top:1.25rem}
  </style>
</head>
<body>
<div class="wrap">
  <h1>DCF &amp; XIRR — P/B/O Scenarios + PE Sensitivity</h1>
  <div class="grid">
    <label>Share price $</label><input id="pNow" type="number" value="100" step="0.1"><small>Market price today</small>
    <label>Revenue B$</label><input id="rev" type="number" value="50" step="1">
    <label>YoY growth %</label><input id="g0" type="number" value="20" step="0.1">
    <label>TAM B$</label><input id="tam" type="number" value="300" step="10">
    <label>Net margin %</label><input id="m0" type="number" value="-5" step="0.1">
    <label>Peak margin %</label><input id="mPk" type="number" value="20" step="0.5">
    <label>Payout %</label><input id="pay" type="number" value="40" step="1"><small>Dividends / NI</small>
    <label>Shares B</label><input id="sh" type="number" value="1" step="0.01">
    <label>Terminal P/E</label><input id="peT" type="number" value="12" step="1">
  </div>
  <button id="runBtn">Run simulation</button>

  <table id="tbl" style="display:none"><thead><tr><th>Scenario</th><th>EPS<sub>n</sub></th><th>Future Price</th><th>XIRR 7y</th><th>XIRR 10y</th><th>XIRR 15y</th></tr></thead><tbody></tbody></table>
  <div id="bar" class="plot"></div>
  <div id="line" class="plot"></div>
</div>

<script>
// === utility shortcuts ===
const $ = id => document.getElementById(id);
const v = id => +($(id)?.value||0);
const logistic = (t,t0,k)=>1/(1+Math.exp(-k*(t-t0)));

function buildEPS(scene,yrs){
  const R0=v('rev'), g0=v('g0')/100, TAM=v('tam');
  const m0=v('m0')/100, mPk=v('mPk')/100, sh=v('sh');
  const adj={P:0.6,B:1,O:1.3}[scene];
  const gPk=g0*adj, tPk=5*adj, k=0.4/adj, mShift=(mPk-m0)*adj;
  let R=R0, arr=[];
  for(let t=1;t<=yrs;t++){
    const g=gPk*(1-logistic(t,tPk,k));
    R=Math.min(R*(1+g),TAM);
    const margin=m0+mShift*logistic(t,tPk,k);
    arr.push((R*margin)/sh);
  }
  return arr;
}

function cashFlow(P,eps,pay,pe){
  const cf=[-P]; eps.forEach(e=>cf.push(e*pay)); cf[cf.length-1]+=eps.at(-1)*pe; return cf;
}

function IRR(cf){
  let r=0.1;
  for(let i=0;i<100;i++){
    let f=0,df=0;
    cf.forEach((c,t)=>{const d=(1+r)**t;f+=c/d;if(t>0)df+=-t*c/(d*(1+r));});
    if(Math.abs(df)<1e-9) return null;
    const rN=r-f/df;
    if(!isFinite(rN)) return null;
    if(Math.abs(rN-r)<1e-6) return rN;
    r=rN;
  }
  return null;
}

function simulate(){
  const price=v('pNow');
  if(!price){alert('Please enter current share price');return;}
  const pay=v('pay')/100, peT=v('peT');
  const tbl=$('tbl'); if(!tbl){console.error('table not found');return;}
  const tbody=tbl.querySelector('tbody'); if(!tbody){console.error('tbody missing');return;}
  tbody.innerHTML='';

  const SC=['P','B','O'], H=[7,10,15];
  const bar10=[];
  SC.forEach(s=>{
    const eps10=buildEPS(s,10);
    const epsMap={7:eps10.slice(0,7),10:eps10,15:[...eps10,...buildEPS(s,5)]};
    const rowIRR={};
    H.forEach(h=>{const r=IRR(cashFlow(price,epsMap[h],pay,peT));rowIRR[h]=r? (r*100).toFixed(2):'n/a';});
    const fut=(eps10.at(-1)*peT).toFixed(2);
    const epsLast=eps10.at(-1).toFixed(2);
    tbody.insertAdjacentHTML('beforeend',`<tr><td>${s}</td><td>${epsLast}</td><td>${fut}</td><td>${rowIRR[7]}</td><td>${rowIRR[10]}</td><td>${rowIRR[15]}</td></tr>`);
    bar10.push(isNaN(+rowIRR[10])?0:+rowIRR[10]);
  });
  tbl.style.display='table';

  Plotly.newPlot('bar',[{x:SC,y:bar10,type:'bar',marker:{color:['#ff6961','#f0ad4e','#5cb85c']}}],{title:'IRR (10‑year horizon)',yaxis:{title:'IRR %'}});

  const peRange=Array.from({length:13},(_,i)=>8+i);
  const irrPE=peRange.map(pe=>{
    const r=IRR(cashFlow(price,buildEPS('B',10),pay,pe));
    return r? r*100 : 0;
  });
  Plotly.newPlot('line',[{x:peRange,y:irrPE,type:'scatter',mode:'lines+markers'}],{title:'IRR vs Terminal P/E (Base, 10y)',xaxis:{title:'Terminal P/E'},yaxis:{title:'IRR %'}});
}

document.addEventListener('DOMContentLoaded',()=>{
  $('runBtn')?.addEventListener('click',simulate);
});
</script>
</body>
</html>
